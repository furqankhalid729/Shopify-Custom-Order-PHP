<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Shopify\Clients\Rest;
use Shopify\Utils;
use Shopify\Rest\Admin2024_04\Order;
use Illuminate\Support\Facades\Log;

class ShopifyDataController extends Controller
{
    protected $validZipCodes = [
        '560063', '560030', '560034', '560007', '560092', '560024', 
        '562106', '560045', '560003', '560050', '562107', '560064', 
        '560047', '560026', '560086', '560002', '560070', '560073', 
        '562149', '560053', '560085', '560043', '560017', '560001', 
        '560009', '560025', '560083', '560076', '560004', '560079', 
        '560103', '560046', '562157', '560010', '560049', '560056', 
        '560068', '560093', '560018', '560040', '560097', '560061', 
        '562130', '560067', '560036', '560029', '560062', '560037', 
        '560071', '562125', '560100', '560005', '560065', '560019', 
        '560021', '560085', '560022', '560013', '560087', '560008', 
        '560051', '560102', '560104', '560094', '560066', '560038', 
        '560078', '560006', '560014', '560015', '560041', '560070', 
        '560069', '560011', '560083', '560079', '560096', '560098', 
        '560095', '560077', '560084', '560054', '560033', '560055', 
        '560059', '560080', '560092', '560012', '560020', '560027', 
        '560042', '560028', '560056', '560052', '560097', '560040', 
        '560091', '560018', '560047', '560064', '560066', '560070', 
        '560078', '560037', '560022', '700020', '700046', '700027', 
        '700014', '700044', '700086', '700022', '700019', '700007', 
        '700008', '700018', '700034', '700010', '700054', '700025', 
        '700066', '700032', '700042', '700012', '700088', '700073', 
        '700017', '700054', '700073', '700001', '700141', '700031', 
        '700013', '700029', '700107', '700016', '700069', '700021', 
        '700047', '700024', '700075', '700095', '700078', '700082', 
        '700072', '700069', '700033', '700078', '700061', '700034', 
        '700068', '700085', '700020', '700082', '700031', '700053', 
        '700063', '700026', '700099', '700089', '700061', '700026', 
        '700001', '700023', '700073', '700001', '700020', '700045', 
        '700029', '700025', '700014', '700071', '700060', '700141', 
        '700071', '700027', '700013', '700099', '700053', '700047', 
        '700011', '700027', '700040', '700053', '700087', '700001', 
        '700024', '700034', '700094', '700017', '700016', '700060', 
        '700009', '700063', '700041', '700032', '700054', '700072', 
        '700026', '700001', '700018', '700001', '700047', '700009', 
        '700044', '700054', '700025', '700029', '700092', '700040', 
        '700001', '700040', '700071', '700094', '700026', '700038', 
        '700015', '700012', '700075', '700075', '700029', '700061', 
        '700015', '700014', '700034', '700017', '700041', '700043', 
        '700072', '700043', '700026', '700007', '700010', '700033', 
        '700024', '700014', '700015', '700088', '700088', '700001', 
        '700063', '700073', '700033', '700001', '700075', '700001', 
        '700062', '700023', '700001', '700012','700120','700121',
        '700122', '700123', '700124', '700125','700126',"500030", "500004", "500045", "500007", "500012", "500015", "500044", "500013", "500004", "501201",
        "500015", "500044", "501301", "501301", "501301", "500030", "500040", "500020", "500048", "500015",
        "500058", "500064", "500005", "500034", "500027", "500004", "500012", "500016", "500003", "500018",
        "500080", "500039", "501301", "500013", "500022", "500024", "500064", "501301", "501301", "500005",
        "500081", "500015", "500008", "500024", "500028", "500006", "500060", "500062", "500062", "500018",
        "500053", "500065", "500018", "500029", "500015", "500001", "500080", "501301", "500015", "500008",
        "500020", "500015", "500068", "500062", "500052", "500066", "500029", "500025", "500001", "500051",
        "500035", "500028", "500064", "500016", "500016", "500008", "500002", "500013", "500001", "500048",
        "500076", "500082", "500007", "500031", "500040", "500015", "500007", "500015", "500079", "500085",
        "500033", "500008", "500058", "500079", "500006", "501301", "500077", "501301", "501301", "500005",
        "500004", "500062", "500003", "500064", "500030", "500015", "501301", "500067", "500015", "500015",
        "500062", "500074", "500063", "500015", "500017", "500017", "500008", "500003", "500081", "500036",
        "500076", "500005", "500006", "500068", "500001", "500002", "500018", "500040", "500015", "500028",
        "500020", "500020", "500044", "500008", "500062", "500029", "500026", "500060", "500063", "500044",
        "500007", "500027", "500015", "500036", "500029", "500012", "500036", "500060", "500025", "500004",
        "500005", "500004", "500015", "500039", "500003", "500015", "500016", "501301", "500095", "500065",
        "500069", "500045", "500071", "500041", "500016", "500030", "500035", "500029", "500095", "501301",
        "500074", "500015", "500023", "501301", "500024", "500059", "500059", "500017", "500008", "500018",
        "500018", "500038", "500059", "500035", "500003", "500001", "500013", "500065", "500028", "500052",
        "500004", "500061", "500076", "500082", "500033", "500073", "500013", "500036", "500001", "500095",
        "500027", "500065", "500015", "500039", "500052", "500018", "500064", "500002", "500007", "501301",
        "500015", "500008", "500080", "500039", "500053", "500070", "500079", "500070", "500038", "500004",
        "500044", "500057", "501101", "501301", "500023", "500045", "500020", "500013",
        "411004", "411040", "410506", "410509", "413132", "411032", "411035", "412411", "412205", "412201",
        "412105", "412211", "412411", "412206", "410507", "411042", "412206", "410401", "411046", "412206",
        "410501", "410507", "412211", "410505", "412218", "411003", "412408", "411051", "412205", "411042",
        "412211", "412410", "410502", "413114", "412212", "410502", "412206", "411021", "412401", "412205",
        "410509", "412207", "412404", "411007", "411027", "411007", "412406", "412402", "412405", "412204",
        "410501", "411002", "410502", "411045", "411007", "413102", "413133", "413102", "413102", "412206",
        "411021", "413103", "412206", "413801", "410506", "412108", "413104", "412410", "412303", "412203",
        "412108", "412209", "413103", "410401", "411042", "413104", "413130", "413105", "410509", "412301",
        "412301", "413103", "412204", "412205", "412206", "410509", "412402", "411026", "411039", "410501",
        "412106", "411042", "411042", "411038", "412206", "410513", "411037", "413106", "412301", "413104",
        "412202", "412411", "412203", "413801", "411003", "412208", "411001", "411031", "410501", "412301",
        "410506", "410503", "412105", "410513", "410502", "412206", "412114", "412409", "412105", "412211",
        "412218", "410505", "411019", "411019", "412101", "411005", "412207", "413132", "412213", "411001",
        "411012", "413801", "413801", "412305", "410505", "412311", "411004", "412213", "412402", "412109",
        "412101", "412214", "413801", "410502", "413110", "410506", "410508", "412403", "412205", "411043",
        "412208", "411015", "411041", "413104", "412409", "411015", "410509", "412409", "412301", "410505"
    ];
    public function orderData(Request $request)
    {
        $store_url = env('STORE_URL');
        $access_token = env('ACCESS_TOKEN');
        $client = new Rest($store_url, $access_token);
        Log::info('Form data submitted:', $request->all());
        $data = $request->input('contact');
        $productId = $data['product_id'] ?? null;
        $name = $data['name'] ?? null;
        $email =  $data['email'] ?? null;
        $phone = $data['phone'] ?? null;
        $address = $data['address'] ?? null;
        $city = $data['city'] ?? null;
        $zip = $data['zip-code'] ?? null;
        $price = $data['price'] ?? null;
        $state =  "Karnataka";
        if($city == "Mumbai"){
            $state =  "West Bengal";
        }
        else if ($city == "Pune"){
            $state =  "Maharashtra";
        }
        else if($city == "Hydrabad"){
            $state =  "Telengana";
        }
        
        if (!in_array($zip, $this->validZipCodes)) {
            return redirect('https://cashito.in/pages/thank-you?status=zip-error');
        }
        $excludeFields = ['name', 'email', 'phone', 'address', 'zip-code','city'];
        $orderNotes = [];
        foreach ($data as $key => $value) {
            if (!in_array($key, $excludeFields)) {
                $orderNotes[] = "$key: $value";
            }
        }
        $orderNotesString = implode(", ", $orderNotes);
        
        $orderData = [
            'order' => [
                'line_items' => [
                    [
                        'variant_id' => "$productId",
                        'quantity' => 1,
                        'price' => $price
                    ],
                ],
                'customer' => [
                    'first_name' => "$name",
                    'last_name' => "$name",
                    'email' => "$email",
                    'phone' => "$phone",
                ],
                'billing_address' => [
                    'first_name' => "$name",
                    'last_name' => "$name",
                    'address1' => "$address",
                    'city' => "$city",
                    'province' => "$state",
                    'country' => 'India',
                    'zip' => "$zip",
                ],
                'shipping_address' => [
                    'first_name' => "$name",
                    'last_name' => "$name",
                    'address1' => "$address",
                    'city' => "$city",
                    'province' => "$state",
                    'country' => 'India',
                    'zip' => "$zip",
                ],
                'financial_status' => 'paid',
                'note' => $orderNotesString,
                'phone' => "$phone"
            ],
        ];
        Log::info('ORder data Before:', $orderData);
        //return response()->json($orderData);
        $response = $client->post('admin/api/2024-04/orders.json', $orderData);
        Log::info('ORder data submit:', [$response->getBody()]);
        if ($response->getStatusCode() === 201) {
            $order = json_decode($response->getBody()->getContents(), true);
            return redirect('https://cashito.in/pages/thank-you?status=success');
        } else {
            return redirect('https://cashito.in/pages/thank-you?status=error');
        }
    }
}
